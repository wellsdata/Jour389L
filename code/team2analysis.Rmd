---
title: "Team 2 Analysis"
author: "Hannah Marszalek, Apurva Mahajan, Sasha Allen, Marwa Barakat"
date: "2023-09-21"
output: html_document
---

In this notebook, we are using the geocoding data to look at how the distance between the newspapers and the lynchings they reported on changed over time.

```{r}
#install.packages("here")
here::here()
library(tidyverse)
library(tidyr)
#install.packages("ggmap")
library(ggmap)
#register_google(key = "YOUR KEY HERE")
library(googlesheets4)
#install.packages("geosphere")
library(geosphere)
#install.packages("kableExtra")
library(kableExtra)
#webshot::install_phantomjs()
library(lubridate)
```

# Analysis
```{r}
lynch_geocoded_9.27 <- read.csv("../data/lynch_geocoded_9.27.csv")

```

```{r}
## Pct of Newspapers in state vs out of state
 lynch_geocoded_9.27 %>% 
  count(in_state) %>% 
  mutate(pct = round(n/3292,2))


# in_state
# N	3068	0.93		
# Y	223	0.07	


summary(lynch_geocoded_9.27$miles)
#Newspapers, on average, were 908.5 miles away from a lynching event during the whole time period
```

## Distance Over Time
```{r}
#cleaning initial data
lynch_geocoded_9.27 <- lynch_geocoded_9.27 %>%
  distinct(file_id, lynch_address, .keep_all = TRUE)

#distance split by decade
distance_by_decade <- lynch_geocoded_9.27 %>% 
  select(decade, miles) %>% 
  group_by(decade) %>% 
  summarize(mean_miles = mean(miles, na.rm=TRUE)) %>%
  mutate(mean_miles = round(mean_miles, digits = 2)) %>%
  arrange(desc(mean_miles))

#formatted table
distance_by_decade %>%
  kbl(caption = "Average Distance of Lynching Reporting by Decade") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = F, font_size = 14)

#write.csv(distance_by_decade, "~/Desktop/average_distance_by_decade.csv")
#write_sheet()

#distance grouped by newspaper title
distance_by_paper <- lynch_geocoded_9.27 %>%
  select(newspaper_name, newspaper_state_code, miles) %>%
  group_by(newspaper_name, newspaper_state_code) %>%
  filter(!is.na(newspaper_name)) %>%
  summarize(mean_miles = mean(miles, na.rm=TRUE)) %>%
  mutate(mean_miles = round(mean_miles, digits = 2)) %>%
  rename(newspaper_name = newspaper_name, newspaper_state = newspaper_state_code) %>%
  arrange(desc(mean_miles))

top_20_papers <- distance_by_paper[1:20, ]

#formatted table
top_20_papers %>%
  kbl(caption = "Newspapers with the Highest Average Lynching Reporting Distance") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = F, font_size = 14)

#write.csv(distance_by_paper, "~/Desktop/average_distance_by_paper.csv")
#write.csv(top_20_papers, "~/Desktop/top_20_papers_distance.csv")

#distance group by newspaper states
distance_by_state <- lynch_geocoded_9.27 %>%
  select(newspaper_state_code, miles) %>%
  group_by(newspaper_state_code) %>%
  summarize(mean_miles = mean(miles, na.rm=TRUE)) %>%
  mutate(mean_miles = round(mean_miles, digits = 2)) %>%
  rename(state = newspaper_state_code) %>%
  arrange(desc(mean_miles))

top_10_states <- distance_by_state[1:10, ]

#formatted table
top_10_states %>%
  kbl(caption = "States with the Highest Average Lynching Reporting Distance") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"), full_width = F, font_size = 14)

#write.csv(distance_by_state, "~/Desktop/average_distance_by_state.csv")
#write.csv(top_10_states, "~/Desktop/top_10_states_distance.csv")

#write.csv(distance_by_paper, "../output/average_reporting_distance_newspapers.csv")

# in_state_yn <- lynch_geocoded_9.16 %>%
#   select(decade, in_state) %>%
#   mutate(
#     yes = case_when(
#     in_state == "Y" ~ "Y",
#     TRUE ~ NA_character_
#     )) %>%
#   mutate(
#     no = case_when(
#     in_state == "N" ~ "N",
#     TRUE ~ NA_character_
#     ))

  # ggplot(x, aes(x=decade, y=n, color=in_state, fill=in_state)) +
  #   geom_col(position = "dodge") + 
  # theme(legend.position = "none") +
  # labs(title = "DRAFT FINDINGS: Little Local Coverage of Lynching",
  #      subtitle = "Local (teal) vs Out-of-State (red) Lynching Coverage",
  #      caption = "Teal bar=In-state. Red Bar=Out-of-State. Source: Library of Congress. n=3188 Graphic by Rob Wells. Sept 20 2024",
  #      y="Count of articles",
  #      x="")

```

```{r}
## Looking into wire coverage: isolate by date and city

#maybe write a case_when for if the date is greater than 15 make it the ceiling date and otherwise make it the floor date?
wire_coverage <- lynch_geocoded_9.27 %>%
  select(newspaper_name, lynch_address, date, miles, newspaper_state_code) %>%
  mutate(fixed_date=mdy(date)) %>%
  mutate(month = floor_date(fixed_date, "month")) %>%
  select(-date) %>%
  rename(paper_state = newspaper_state_code)

duplicates <- wire_coverage[duplicated(wire_coverage$lynch_address) | duplicated(wire_coverage$lynch_address, fromLast = TRUE), ]

check_duplicates <- duplicates %>%
  group_by(lynch_address) %>%
  count()

#write_sheet(wire_coverage, "https://docs.google.com/spreadsheets/d/1yt78ISXWJxpqig1x2feStOdtcnjOHA8vLf46lqe6zcE/edit#gid=0", sheet = "wire_coverage")

#write_sheet(duplicates, "https://docs.google.com/spreadsheets/d/1yt78ISXWJxpqig1x2feStOdtcnjOHA8vLf46lqe6zcE/edit#gid=0", sheet = "only_duplicate_cities")

city_and_date <- duplicates[duplicated(duplicates[, c("lynch_address", "month")]) | duplicated(duplicates[, c("lynch_address", "month")], fromLast = TRUE), ]

#write_sheet(city_and_date, "https://docs.google.com/spreadsheets/d/1yt78ISXWJxpqig1x2feStOdtcnjOHA8vLf46lqe6zcE/edit#gid=0", sheet = "duplicate_cities_and_months")

#counting possible total of wire coverage cases
counting_wire_cases <- lynch_geocoded_9.27 %>%
  select(newspaper_name, lynch_address, date, miles, newspaper_state_code, state_lynch) %>%
  mutate(fixed_date=mdy(date)) %>%
  mutate(month = floor_date(fixed_date, "month")) %>%
  select(-date) %>%
  rename(paper_state = newspaper_state_code)

counting_wire_cases <- counting_wire_cases[duplicated(counting_wire_cases[, c("lynch_address", "month")]) | duplicated(counting_wire_cases[, c("lynch_address", "month")], fromLast = TRUE), ]

counting_wire_cases <- counting_wire_cases %>%
  mutate(wire_case = 
           case_when(
             paper_state == state_lynch ~ "n",
             TRUE ~ "y"
             )) %>%
  filter(wire_case == "y") %>%
  filter(lynch_address != "NA, NA" & lynch_address != "None, NONE") %>%
  select(-wire_case)

wire_newspapers <- counting_wire_cases %>%
  group_by(newspaper_name, paper_state) %>%
  summarize(mean_miles = mean(miles, na.rm=TRUE), count = n()) %>%
  filter(!is.na(newspaper_name)) %>%
  mutate(mean_miles = round(mean_miles, digits = 2))
```

```{r}
## Regional differences

#starter code
m <- lynch_geocoded_9.16 %>% 
  select(decade, Newspaper_Region, in_state) %>% 
  group_by(Newspaper_Region) %>% 
  count(in_state)

```
